<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="description" content="Suffix Array is a sorted array of all suffixes of a string T with usually long length n. It is a simple, yet powerful data structure which is used, among others, in full text indices, data compression algorithms, and within the field of bioinformatics. This data structure is very related to Suffix Tree data structure.">
<meta name="keywords" content="后缀数组构造公共前缀LCP字符串匹配最长重复子串&lt;br&gt;">
 
<meta name="csrf-token" content="kaTPcaTtnnJPvGspW7LRTya6UONjjAL7yXZSCSBh">
<meta http-equiv="X-UA-Compatible" content="IE=EDGE">
<meta property="og:image" content="../img/png/suffixarray.png">
<title>VisuAlgo - 后缀数组&lt;br&gt;</title>
<link rel="icon" href="../img/favicon.png" type="image/x-icon">
<link rel="shortcut icon" href="../img/favicon.png" type="image/x-icon">
<link rel="apple-touch-icon" href="../img/favicon.png">
<link rel="apple-touch-icon" sizes="72x72" href="../img/favicon.png">
<link rel="apple-touch-icon" sizes="114x114" href="../img/favicon.png">
<link rel="stylesheet" type="text/css" href="../fonts/silkscreen/stylesheet.css">
<link rel="stylesheet" type="text/css" href="../css/common.css">
<link rel="stylesheet" href="../css/viz-1.0.1.css">
<link rel="stylesheet" href="../css/visual.css">
<link rel="stylesheet" href="../css/drawgraph.css">
<style>
      #e-lecture {
        top: 45px;
        right: 130px;
        width: 400px;
        display: block;
        background: none;
        /*overflow: normal;*/
        white-space: normal;
        text-align: right;
        color: black; font-weight: bold; font-size: 20px;
      }
      .electure-prev, .electure-next { /* force update, copied from viz.css */
        position: absolute;
        /* bottom: -12px; */
        top: -20px;
        /*bottom: '';*/
        padding: 3px 8px;
        background: #999;
        color: white;
        cursor: pointer;
        border-radius: 2px;
      }
      .electure-prev {
        left: -10px;
        /* right: 30px; */
      }
      .electure-next {
        right: -10px;
        color: white;
      }
    </style>
<style>
.construct { bottom: 172px; }
  #construct-input input {
    width: 200px;
    padding: 8px;
  }
  #construct-go p { padding: 8px 8px 7px; }
  #construct-err { padding: 8px 0px 7px; }

.search { bottom: 146px; }
  #search-input input {
    width: 200px;
    padding: 6px 8px 5px;
  }
  #search-go p { padding: 5px 8px; }    
  #search-err { padding: 5px 0px; }

.lcp { bottom: 119px; }
  #lcp-err { padding: 5px 0px; }

.lrs { bottom: 92px; }
  #lrs-err { padding: 5px 0px; }

.lcs { bottom: 60px; }
  #lcs-input input {
    width: 78px;
    padding: 8px;
  }
  #lcs-go p { padding: 8px 8px 7px; }
  #lcs-err { padding: 8px 0px 7px; }

/*others*/
.background {
  fill: none;
  pointer-events: all;
}

.lcs_first {
  fill: #2ebbd1;
}

.lcs_second {
  fill: #52bc69;
}
</style>
<script>
      function changeURL() {
        var URL = window.location.href.split('/');
        var val = document.getElementById("Language").value;
        URL[3] = val;
        window.location.assign(URL.join('/'));
      }
    </script>
</head>
<body>
<div id="top-bar">
<a id="home" href="/">Visu<span class="colour">Algo</span><span style="font-size: 40%">.net</span></a>
/
<select id="Language" onchange="changeURL()">
<option value="zh" selected>zh</option>
</select>
/suffixarray
<span id="title">
<a id='title-suffixarray' class='selected-viz'>后缀数组</a>
</span>
<div id="mode-menu">
<div id='mode-button' title='exploration'>示例模式 &#9663;</div>
<div id='other-modes'>
<a title='e-Lecture'>电子讲座模式</a>
</div>
</div>
</div>
<div id="dark-overlay"></div>
<div id="status" class="panel"><p></p></div>
<div id="status-hide" class="panel-hide"><img src="../img/arrow_white_right.png" alt=">" title="show/hide status panel" /></div>
<div id="codetrace" class="panel">
<p id="code1" style="padding-top: 10px;"></p>
<p id="code2"></p>
<p id="code3"></p>
<p id="code4"></p>
<p id="code5"></p>
<p id="code6"></p>
<p id="code7" style="padding-bottom: 10px;"></p>
</div>
<div id="codetrace-hide" class="panel-hide"><img src="../img/arrow_white_right.png" alt=">" title="show/hide codetrace panel" /></div>
<div id="left-bar"></div>
<div id="right-bar"></div>
<div id="media-controls">
<div id='speed-control'>减速<div id='speed-input'></div>加速</div>
<span id="go-to-beginning" class="media-control-button" title="go to beginning" onclick=goToBeginning()><img src="../img/goToBeginning.png" alt="go to beginning"></span>
<span id="previous" class="media-control-button" title="step backward" onclick=stepBackward()><img src="../img/prevFrame.png" alt="previous frame"></span>
<span id="pause" class="media-control-button" title="pause" onclick=pause()><img src="../img/pause.png" alt="pause"></span>
<span id="play" class="media-control-button" title="play" onclick=play()><img src="../img/play.png" alt="play"></span>
<span id="next" class="media-control-button" title="step forward" onclick=stepForward()><img src="../img/nextFrame.png" alt="next frame"></span>
<span id="go-to-end" class="media-control-button" title="go to end" onclick=goToEnd()><img src="../img/goToEnd.png" alt="go to end"></span>
<div id="progress-bar" class="media-control-button"></div>
</div>
<div id='viz'></div>
<div id='current-action' class='panel'></div>
<div id='e-lecture' class='panel'></div>
<div id="overlay" hidden></div>
<div id="dropdown-temp-holder" hidden></div>
<div id="electure-1" class="electure-dialog" style="top:60px;left:60px;width:500px;">
<p><strong>Suffix Array</strong> is a sorted array of all suffixes of a string <b>T</b> with usually long length <b>n</b>. It is a simple, yet powerful data structure which is used, among others, in full text indices, data compression algorithms, and within the field of bioinformatics. This data structure is very related to <a href="./suffixtree"><u>Suffix Tree</u></a> data structure.</p>
<hr>
<p><b>Remarks</b>: By default, we show e-Lecture Mode for first time (or non logged-in) visitor.<br>
Please <a href="login"><u>login</u></a> if you are a repeated visitor or <a href="login"><u>register</u></a> for an (optional) free account first.</p>
<div id='electure-dropdown'>
<select class="lecture-dropdown" style="width:100%">
<option value="1">1. Suffix Array</option>
<option value="2">2. Visualisation</option>
<option value="3">3. Available operations</option>
<option value="4">4. Implementation</option>
<option value="99">99. 状态面板</option>
<option value="99-1">&nbsp;&nbsp;&nbsp;99-1. 代码追踪面板</option>
<option value="99-2">&nbsp;&nbsp;&nbsp;99-2. 媒体控制</option>
<option value="99-3">&nbsp;&nbsp;&nbsp;99-3. 返回 ”探索模式“</option>
</select>
</div>
<div class='electure-end'>X <u>Esc</u></div>
<div class='electure-next' data-nextid="2">下一个 <u>PgDn</u></div>
</div>
<div id="electure-2" class="electure-dialog" style="top:270px;left:50%;margin-left:-200px;width:400px;">
后缀数组的可视化仅仅是一个表，其中每行代表一个后缀，每一列代表后缀的属性。<br>
<hr>
<p>Pro-tip: Since you are not <a href="login"><u>logged-in</u></a>, you may be a first time visitor who are not aware of the following keyboard shortcuts to navigate this e-Lecture mode: <b>[PageDown]</b> to advance to the next slide, <b>[PageUp]</b> to go back to the previous slide, <b>[Esc]</b> to toggle between this e-Lecture mode and exploration mode.</p>
<div class='electure-end'>X <u>Esc</u></div>
<div class='electure-prev' data-nextid="1">上一个 <u>PgUp</u></div>
<div class='electure-next' data-nextid="3">下一个 <u>PgDn</u></div>
</div>
<div id="electure-3" class="electure-dialog" style="bottom:230px;left:60px;width:610px;">
<p>All available operations on the Sufix Array are listed below.</p><ol><li><b>Construct Suffix Array (SA)</b> is the O(<b>n</b> log <b>n</b>) Suffix Array construction algorithm based on the idea by Karp, Miller, &amp; Rosenberg (1972) that sort prefixes of the suffix in increasing length (1, 2, 4, 8, ...).</li><li><b>Search</b> utilizes the fact that the suffixes in Suffix Array are sorted and call two binary searches in O(<b>m</b> log <b>n</b>) to find the first and the last occurrence(s) of pattern string <b>P</b> of length <b>m</b>.</li><li><b>Longest Common Prefix (LCP)</b> between two adjacent suffixes (excluding the first suffix) can be computed in O(<b>n</b>) using the Permuted LCP (PLCP) theorem.</li><li><b>Longest Repeated Substring (LRS)</b> is a simple O(<b>n</b>) algorithm that finds the suffix with the highest LCP value.</li><li><b>Longest Common Substring (LCS)</b> is a simple O(<b>n</b>) algorithm that finds the suffix with the highest LCP value that comes from two different strings.</li></ol>
<hr>
<p>Another pro-tip: We designed this visualization and this e-Lecture mode to look good on 1366x768 resolution <b>or larger</b> (typical modern laptop resolution in 2017). We recommend using Google Chrome to access VisuAlgo. Go to full screen mode (<b>F11</b>) to enjoy this setup. However, you can use zoom-in (<b>Ctrl +</b>) or zoom-out (<b>Ctrl -</b>) to calibrate this.</p>
<div class='electure-end'>X <u>Esc</u></div>
<div class='electure-prev' data-nextid="2">上一个 <u>PgUp</u></div>
<div class='electure-next' data-nextid="4">下一个 <u>PgDn</u></div>
</div>
<div id="electure-4" class="electure-dialog" style="top:60px;left:60px;width:500px;">
<p>You are allowed to use/modify our implementation code for fast Suffix Array+LCP:<br><a href="https://github.com/stevenhalim/cpbook-code/blob/master/ch6/sa_lcp.cpp" target="_blank"><u>sa_lcp.cpp</u></a><br><a href="https://github.com/stevenhalim/cpbook-code/blob/master/ch6/sa_lcp.java" target="_blank"><u>sa_lcp.java</u></a><br><a href="https://github.com/stevenhalim/cpbook-code/blob/master/ch6/sa_lcp.py" target="_blank"><u>sa_lcp.py</u></a><br><a href="https://github.com/stevenhalim/cpbook-code/blob/master/ch6/sa_lcp.ml" target="_blank"><u>sa_lcp.ml</u></a><br></p>
<div class='electure-end'>X <u>Esc</u></div>
<div class='electure-prev' data-nextid="3">上一个 <u>PgUp</u></div>
<div class='electure-next' data-nextid="99">下一个 <u>PgDn</u></div>
</div>
<div id="electure-99" class="electure-dialog" style="right:150px;bottom:335px;width:500px;">
当操作进行时，状态面板将会有每个步骤的描述。
<div class='electure-end'>X <u>Esc</u></div>
<div class='electure-prev' data-nextid="4">上一个 <u>PgUp</u></div>
<div class='electure-next' data-nextid="99-1">下一个 <u>PgDn</u></div>
</div>
<div id="electure-99-1" class="electure-dialog" style="right:170px;bottom:275px;width:180px;">
<div style="background-color: white; color: black;">
<p>e-Lecture: The content of this slide is hidden and only available for legitimate CS lecturer worldwide. Drop an email to visualgo.info at gmail dot com if you want to activate this CS lecturer-only feature <b>and you are really a CS lecturer (show your University staff profile)</b>.</p>
</div>
<div class='electure-end'>X <u>Esc</u></div>
<div class='electure-prev' data-nextid="99">上一个 <u>PgUp</u></div>
<div class='electure-next' data-nextid="99-2">下一个 <u>PgDn</u></div>
</div>
<div id="electure-99-2" class="electure-dialog" style="bottom:70px;left:50%;margin-left:-120px;width:260px;">
使用用户控件控制动画！可用的快捷键有：<div>空格键：绘制／停止／重绘</div><div>左／右箭头：上一步／下一步</div><div>-／+：减缓／增加速度</div><div><br></div>
<div class='electure-end'>X <u>Esc</u></div>
<div class='electure-prev' data-nextid="99-1">上一个 <u>PgUp</u></div>
<div class='electure-next' data-nextid="99-3">下一个 <u>PgDn</u></div>
</div>
<div id="electure-99-3" class="electure-dialog" style="top:70px;right:60px;width:300px;">
<p>Return to &#39;Exploration Mode&#39; to start exploring!</p><br><p>Note that if you notice any bug in this visualization or if you want to request for a new visualization feature, do not hesitate to drop an email to the project leader: Dr Steven Halim via his email address: stevenhalim at gmail dot com.</p>
<div class='electure-end'>X <u>Esc</u></div>
<div class='electure-prev' data-nextid="99-2">上一个 <u>PgUp</u></div>
</div>
<div id="popup" hidden>
<div id="popup-content"></div>
<span id="hide-popup" hidden>X <u>关闭</u></span>
</div>
<div id="actions" class="panel">
<p id="construct">构造后缀数组<br></p>
<p id="search">搜索</p>
<p id="LCP" class="execAction" onclick=doLCP()>最长公共前缀<br></p>
<p id="LRS" class="execAction" onclick=doLRS()>最长重复子串<br></p>
<p id="LCS">最长公共子串<br></p>
</div>
<div id="actions-hide" class="panel-hide"><img src="../img/arrow_white_right.png" alt=">" title="show/hide actions panel" /></div>
<div id="actions-extras">
<div class="construct action-menu-pullout">
<div id="construct-input" class="new-menu-option"><input type="text" id="T" autocomplete="off" value="GATAGACA$" /></div>
<div id="construct-go" class="execAction coloured-menu-option" onclick=constructSuffixArray()><p>执行</p></div>
<div id="construct-err" class="err"></div>
</div>
<div class="search action-menu-pullout">
<div id="search-input" class="new-menu-option"><input type="text" id="search_inp" autocomplete="off" value="GA" /></div>
<div id="search-go" class="execAction coloured-menu-option" onclick=doSearch()><p>执行</p></div>
<div id="search-err" class="err"></div>
</div>
<div class="lcp action-menu-pullout">
<div id="lcp-err" class="err"></div>
</div>
<div class="lrs action-menu-pullout">
<div id="lrs-err" class="err"></div>
</div>
<div class="lcs action-menu-pullout">
<div id="lcs-input" class="new-menu-option"><input type="text" id="s1" autocomplete="off" value="CATA#" style="border-right: 1px solid #777;" /><input type="text" id="s2" autocomplete="off" value="GATAGACA$" /></div>
<div id="lcs-go" class="execAction coloured-menu-option" onclick=doLCS()><p>执行</p></div>
<div id="lcs-err" class="err"></div>
</div>
</div>
<div id="bottom-bar">
<a id="trigger-about">关于</a>
</div>
<div id="about" class="overlays">
<h4>关于</h4><span class='close-overlay'>&#x2715;</span>
<div class='content'>
VisuAlgo在2011年由Steven Halim博士概念化，作为一个工具，帮助他的学生更好地理解数据结构和算法，让他们自己和自己的步伐学习基础。<br>VisuAlgo包含许多高级算法，这些算法在Steven Halim博士的书（“竞争规划”，与他的兄弟Felix Halim博士合作）和其他书中讨论。今天，一些高级算法的可视化/动画只能在VisuAlgo中找到。<br>虽然专门为新加坡国立大学（NUS）学生采取各种数据结构和算法类（例如CS1010，CS1020，CS2010，CS2020，CS3230和CS3230），作为在线学习的倡导者，我们希望世界各地的好奇心发现这些可视化也很有用。<br>VisuAlgo不是从一开始就设计为在小触摸屏（例如智能手机）上工作良好，因为需要满足许多复杂的算法可视化，需要大量的像素和点击并拖动手势进行交互。一个令人尊敬的用户体验的最低屏幕分辨率为1024x768，并且只有着陆页相对适合移动设备。<br>VisuAlgo是一个正在进行的项目，更复杂的可视化仍在开发中。<br>最令人兴奋的发展是自动问题生成器和验证器（在线测验系统），允许学生测试他们的基本数据结构和算法的知识。这些问题是通过一些规则随机生成的，学生的答案会在提交给我们的评分服务器后立即自动分级。这个在线测验系统，当它被更多的世界各地的CS教师采用，应该技术上消除许多大学的典型计算机科学考试手动基本数据结构和算法问题。通过在通过在线测验时设置小（但非零）的重量，CS教练可以（显着地）增加他/她的学生掌握这些基本问题，因为学生具有几乎无限数量的可以立即被验证的训练问题他们参加在线测验。培训模式目前包含12个可视化模块的问题。我们将很快添加剩余的8个可视化模块，以便VisuAlgo中的每个可视化模块都有在线测验组件。<br>另一个积极的发展分支是VisuAlgo的国际化子项目。我们要为VisuAlgo系统中出现的所有英语文本准备一个CS术语的数据库。这是一个很大的任务，需要众包。一旦系统准备就绪，我们将邀请VisuAlgo游客贡献，特别是如果你不是英语母语者。目前，我们还以各种语言写了有关VisuAlgo的公共注释：<br>
<a href="https://weibo.com/p/230418436e9ee80102v4rk" target='_blank'><u>zh</u></a>, <a href='https://www.facebook.com/notes/steven-halim/httpidvisualgonet-visualisasi-struktur-data-dan-algoritma-dengan-animasi/10153236934439689' target='_blank'><u>id</u></a>, <a href="https://blog.naver.com/visualgo_nus" target='_blank'><u>kr</u></a>, <a href='https://www.facebook.com/groups/163215593699283/permalink/824003417620494/' target='_blank'><u>vn</u></a>, <a href='http://pantip.com/topic/32736343' target='_blank'><u>th</u></a>.</p>
</div>
</div>

<script src="../js/jquery-3.3.1.min.js"></script>
<script>
      var PHP_DOMAIN = "";

      // surprise colour!
      // Referenced to in  home.js and viz.js also
      var colourArray = ["#52bc69", "#d65775"/*"#ed5a7d"*/, "#2ebbd1", "#d9513c", "#fec515", "#4b65ba", "#ff8a27", "#a7d41e"]; // green, pink, blue, red, yellow, indigo, orange, lime

      function disableScroll() { $('html').css('overflow', 'hidden'); }

      function enableScroll() { $('html').css('overflow', 'visible'); }

      function replaceAll(find, replace, str) { return str.replace(new RegExp(find, 'g'), replace); }

      function getColours() {
        var generatedColours = new Array();
        while (generatedColours.length < 4) {
          var n = (Math.floor(Math.random() * colourArray.length));
          if ($.inArray(n, generatedColours) == -1)
            generatedColours.push(n);
        }
        return generatedColours;
      }

      function isOn(value, position) {
        return (value>>position) & 1 === 1;
      }

      function customAlert(msg) {
        $('#custom-alert p').html(msg);
        var m = -1 * ($('#custom-alert').outerHeight()/2);
        $('#custom-alert').css('margin-top', m+'px');
        $('#dark-overlay').fadeIn(function() {
          $('#custom-alert').fadeIn(function() {
            setTimeout(function() {
              $('#custom-alert').fadeOut(function() {
                $('#dark-overlay').fadeOut();
              });
            }, 1000);
          });
        });
      }

      function showLoadingScreen() {
        $('#loading-overlay').show();
        $('#loading-message').show();
      }

      function hideLoadingScreen() {
        $('#loading-overlay').hide();
      }

      function commonAction(retval, msg) {
        //setTimeout(function() {
          if (retval) { // mode == "exploration" && // now not only for exploration mode, but check if this opens other problems
            $('#current-action').show();
            $('#current-action').html(mode == "exploration" ? msg : ("e-Lecture Example (auto play until done)<br>" + msg));
            $('#progress-bar').slider("option", "max", gw.getTotalIteration()-1);
            triggerRightPanels();
            isPlaying = true;
          }
        //}, 500);
      }

      function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split('=');
          if (decodeURIComponent(pair[0]) == variable)
            return decodeURIComponent(pair[1]);
        }
        return "";
      }

      var generatedColours = getColours();
      var surpriseColour = colourArray[generatedColours[0]];
      var colourTheSecond = colourArray[generatedColours[1]];
      var colourTheThird = colourArray[generatedColours[2]];
      var colourTheFourth = colourArray[generatedColours[3]];

      $(function() {
        $('.links').css('background', surpriseColour);
        $('.right-links').css('background', surpriseColour);
        $('#login-go').css('background', surpriseColour);

        $('.colour').css("color", surpriseColour); // name
        $('h4').css("background-color", surpriseColour); // about, contact us etc. button background

        // title
        $('#title a').click(function() {
          $('#title a').removeClass('selected-viz');
          $(this).addClass('selected-viz');
          // temporary quick fix for Google Chrome Aug 2016 issue...
          setTimeout(function(){ document.body.style.zoom = "100.1%"; }, 100); // force resize/redraw...
          setTimeout(function(){ document.body.style.zoom = "100%"; }, 600);
        });

        // overlays stuffs
        $('#trigger-about').click(function() {
          if ($(window).width() > 600) {
            $('#dark-overlay').fadeIn(function() {
              $('#about').fadeIn();
            });
          }
          else
            alert('Sorry, this dialog is too big. Please load it on bigger screen');
        });

        $('.close-overlay').click(function() {
          $('.overlays').fadeOut(function() {
            $('#dark-overlay').fadeOut();
          });
        });

        $('#dark-overlay').click(function() {
          $('.overlays').fadeOut();
          $('#dark-overlay').fadeOut();
        });
      });
    </script>

<script src="../js/jquery-ui.min.js"></script>
<script src="../js/d3.min.js"></script>
<script src="../js/viz-1.0.3.js"></script>
<script src="../js/visualgo_print.js"></script>
<script src="../js/graph_library.js"></script>
<script>
      function runSlide(slide) {
        if (slide == '1') {
          $("#e-lecture").html("slide " + slide + " (" + 12 + "%)");
          
          hideEntireActionsPanel();
          hideStatusPanel();
          hideCodetracePanel();
      
        }
        if (slide == '2') {
          $("#e-lecture").html("slide " + slide + " (" + 25 + "%)");
          
          hideEntireActionsPanel();
          hideStatusPanel();
          hideCodetracePanel();
      
        }
        if (slide == '3') {
          $("#e-lecture").html("slide " + slide + " (" + 37 + "%)");
          
          showActionsPanel();
          hideStatusPanel();
          hideCodetracePanel();
      
        }
        if (slide == '4') {
          $("#e-lecture").html("slide " + slide + " (" + 50 + "%)");
          
          hideEntireActionsPanel();
          hideStatusPanel();
          hideCodetracePanel();
      
        }
        if (slide == '99') {
          $("#e-lecture").html("slide " + slide + " (" + 62 + "%)");
          
          hideEntireActionsPanel();
 
          showStatusPanel();
          showCodetracePanel();
      
        }
        if (slide == '99-1') {
          $("#e-lecture").html("slide " + slide + " (" + 75 + "%)");
          
          hideEntireActionsPanel();
          hideStatusPanel();
          hideCodetracePanel();
      
        }
        if (slide == '99-2') {
          $("#e-lecture").html("slide " + slide + " (" + 87 + "%)");
          
          hideEntireActionsPanel();
          hideStatusPanel();
          hideCodetracePanel();
      
        }
        if (slide == '99-3') {
          $("#e-lecture").html("slide " + slide + " (" + 100 + "%)");
          
          hideEntireActionsPanel();
          hideStatusPanel();
          hideCodetracePanel();
      
        }
      }

      window.onpopstate = function(event) {
        var slide = event.state['slide'];
        openSlide(slide, function() {
          runSlide(slide);
        });
      };

      function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'), sParameterName, i;

        for (i = 0; i < sURLVariables.length; i++) {
          sParameterName = sURLVariables[i].split('=');
          if (sParameterName[0] === sParam) return sParameterName[1] === undefined ? true : sParameterName[1];
        }
      };

      function pushState(slideValue) {
        var url = '/zh/suffixarray';
        if (typeof slideValue != 'undefined' && slideValue != null) url += '?slide=' + slideValue;
        window.history.pushState({slide: slideValue}, "slide " + slideValue, url);
      }

      function showPopup(callback) {
        $('#popup').fadeIn(100, callback);
      }

      function hidePopup(callback) {
        $('#popup').fadeOut(100, callback);
      }

      function showOverlay() {
        $('#overlay').css('opacity', 0.5); 
        $('#overlay').show();
      }

      function hideOverlay() {
        $('#overlay').hide();
        $("#e-lecture").html("");
      }

      function makeOverlayTransparent() {
        $('#overlay').css('opacity', 0);
      }

      function hideSlide(callback) {
        isPlaying = true;
        closeSlide(cur_slide, function() {
          makeOverlayTransparent();
          setTimeout(callback, 700); // don't immediately run the animation, wait for 500ms+ first
        });
      }

      function showSlide() {
        isPlaying = false;
        openSlide(cur_slide);
        showOverlay();
      }

      $(function() {
        var slide = getUrlParameter('slide');
        
        $.get('/hasvisited' + '/suffixarray', function(data) {
          var hasVisited = data['hasvisited'] == '1';
          if (!hasVisited) {
            var postData = {
              '_token': 'kaTPcaTtnnJPvGspW7LRTya6UONjjAL7yXZSCSBh',
              'page': '/suffixarray'.substring(1),
            };

            $.post("/visitpage", postData, function(data) {
              // non critical request...
            });

            if (typeof slide != undefined && slide != null) {
              cur_slide = slide;
            }

            $("#mode-menu a").trigger("click");
          }
          else {
            if (typeof slide != undefined && slide != null) {
              cur_slide = slide;
              $('#mode-menu a').click();
            }    
          }
        }).fail(function() {
          if (typeof slide != undefined && slide != null) {
            cur_slide = slide;
            $('#mode-menu a').click();
          }
        });

        $('.mcq-submit').click(function() {
          var questionId = parseInt($(this).attr('id').split('-')[1]);
          var answer = $('#mcq-answer-' + questionId).val();
          var userAnswer = $('input[type=radio][name=mcq-'+questionId+'-choice]:checked').val();

          if (answer === userAnswer) {
            $('#answer-status-' + questionId).html('<font color="green"><b>Correct!</b></font>');
          }
          else {
            $('#answer-status-' + questionId).html('<font color="red"><b>Wrong Answer! Try again...</b></font>');
          }
          $('#answer-status-' + questionId).show();
          setTimeout(function() {
            $('#answer-status-' + questionId).fadeOut(1000);
          }, 1000);
        });

        $('.msq-submit').click(function() {
          var questionId = parseInt($(this).attr('id').split('-')[1]);
          var answer = $('#msq-answer-' + questionId).val();

          var answers = [];
          $('input[type=checkbox][class=msq-choice]:checked').each(function() {
            answers.push($(this).attr('id').split('-')[3]);
          });
          answers.sort();
          var userAnswer = answers.join(',');

          if (answer === userAnswer) {
            $('#answer-status-' + questionId).html('<font color="green">Correct!</font>');
          }
          else {
            $('#answer-status-' + questionId).html('<font color="red">Wrong Answer! Try again...</font>');
          }
          $('#answer-status-' + questionId).show();
          setTimeout(function() {
            $('#answer-status-' + questionId).fadeOut(1000);
          }, 1000);
        });

        $('select.lecture-dropdown').change(function() {
          var nextSlide = $(this).val();
          openSlide(nextSlide, function() {
            runSlide(nextSlide);
            pushState(nextSlide);
          });
        });

        $('#hide-popup').click(function() {
          hidePopup();
        });

        $('#popup').hover(function() {
          $('#hide-popup').show();
        }, function() {
          $('#hide-popup').hide();
        });

        $('#electure-1 .electure-next').click(function() {
          hidePopup();
          runSlide('2');
          pushState('2');
        });
      
        $('#electure-2 .electure-next').click(function() {
          hidePopup();
          runSlide('3');
          pushState('3');
        });
        $('#electure-2 .electure-prev').click(function() {
          hidePopup();
          runSlide('1');
          pushState('1');
        });
      
        $('#electure-3 .electure-next').click(function() {
          hidePopup();
          runSlide('4');
          pushState('4');
        });
        $('#electure-3 .electure-prev').click(function() {
          hidePopup();
          runSlide('2');
          pushState('2');
        });
      
        $('#electure-4 .electure-next').click(function() {
          hidePopup();
          runSlide('99');
          pushState('99');
        });
        $('#electure-4 .electure-prev').click(function() {
          hidePopup();
          runSlide('3');
          pushState('3');
        });
      
        $('#electure-99 .electure-next').click(function() {
          hidePopup();
          runSlide('99-1');
          pushState('99-1');
        });
        $('#electure-99 .electure-prev').click(function() {
          hidePopup();
          runSlide('4');
          pushState('4');
        });
      
        $('#electure-99-1 .electure-next').click(function() {
          hidePopup();
          runSlide('99-2');
          pushState('99-2');
        });
        $('#electure-99-1 .electure-prev').click(function() {
          hidePopup();
          runSlide('99');
          pushState('99');
        });
      
        $('#electure-99-2 .electure-next').click(function() {
          hidePopup();
          runSlide('99-3');
          pushState('99-3');
        });
        $('#electure-99-2 .electure-prev').click(function() {
          hidePopup();
          runSlide('99-1');
          pushState('99-1');
        });
      
        $('#electure-99-3 .electure-prev').click(function() {
          hidePopup();
          runSlide('99-2');
          pushState('99-2');
        });
      
 

        // temporary quick fix for Google Chrome Aug 2016 issue..., put at last part so that everything else has been loaded
        // setTimeout(function(){ document.body.style.zoom = "100.1%"; }, 500);
        // setTimeout(function(){ document.body.style.zoom = "100%"; }, 600);
        // I turn it off on 14 June 2018, seems 'ok'?
      });


      function adjustPopupToImageSize() {
        var width = $('#popup-image').prop('width');
        var height = $('#popup-image').prop('height');
        $('#popup').width(width + 20);
        $('#popup').height(height + 20);
        if (width == 0 && height == 0) {
          setTimeout(adjustPopupToImageSize, 200);
        } else {
          showPopup();  
        }
      }

      function POPUP_IMAGE(url) {
        $('#popup-content').html('<img id="popup-image" src="' + url + '">');
        adjustPopupToImageSize();
      }

      function URL(url) {
        window.open(url, '_blank');
      }

      // Implement these functions in each visualisation
      // This function will be called before entering e-Lecture Mode
      function ENTER_LECTURE_MODE() {}

      // This function will be called before returning to Explore Mode
      function ENTER_EXPLORE_MODE() {}

      // Lecture action functions
      function CUSTOM_ACTION(action, data, mode) {}
    </script>
<script type="text/javascript">
// Suffix Array Widget
// original author: Nguyen Hoang Duy, then maintained by Steven Halim

var SuffixArrayWidget = function() {
  var self = this;
  var graphWidget = new GraphWidget();

  var coord = new Array();
  var A = new Array();
  var amountVertex = 0;
  var amountEdge = 0;

  var stateList = [];
  var edgeGenerator = d3.svg.line()
  .x(function(d){return d.x;})
  .y(function(d){return d.y;})
  .interpolate("linear");
  var mousedown_node = null;
  var mousemove_coor = null;
  var edgeList = [];
  var mousedown_in_progress = false, mousemove_in_progress = false, mouseup_in_progress = false;
  var mousedown_event = null, mousemove_event = null, mouseup_event = null;
  var deleted_vertex_list = [];
  var used_alt = -1;
  var adjMatrix = [], adjList = [];
  var aborted_mousedown = false;
  var move1 = true;
  var screenHeight = window.innerHeight-100;
  var screenWidth = window.innerWidth-80;
  var firstNode = -1;
  var isCheckingPointInside = false;
  var cutPolygonState = 0;
  var isPreviousPointInsde = false;
  var isPolygon = false;
  var coord_idx = new Array();
  var coord_data = new Array();
  var suffix_table = new Array();
  var SA = new Array();
  var LCP = new Array();
  var c, r = 0;
  var tempSA = new Array(), SA = new Array(), RA = new Array(), tempRA = new Array();
  var previous_option = null;
  var left_start = 50;

  mainSvg.style("class", "unselectable");

  mainSvg.attr("height", screenHeight);
  mainSvg.attr("width", screenWidth);
  //graphWidget.addRectVertex(100, 100, "ABC", 1, true);

  function resetEverything() {
    coord = new Array();
    A = new Array();
    amountVertex = 0;
    amountEdge = 0;
    //graphWidget = new GraphWidget();
    stateList = [];
    edgeGenerator = d3.svg.line()
    .x(function(d){return d.x;})
    .y(function(d){return d.y;})
    .interpolate("linear");
    mousedown_node = null;
    mousemove_coor = null;
    edgeList = [];
    mousedown_in_progress = false, mousemove_in_progress = false, mouseup_in_progress = false;
    mousedown_event = null, mousemove_event = null, mouseup_event = null;
    deleted_vertex_list = [];
    used_alt = -1;
    adjMatrix = [];
    adjList = [];
    aborted_mousedown = false;
    firstNode = -1;
    isCheckingPointInside = false;
    cutPolygonState = 0;
    isPreviousPointInsde = false;
    isPolygon = false;
    coord_idx = new Array();
    coord_data = new Array();
    suffix_table = new Array();
    SA = new Array();
    LCP = new Array();
    tempSA = new Array(), SA = new Array(), RA = new Array(), tempRA = new Array();
    previous_option = null;
  }

  function createState(lower_bound) {
    var state = {
      "vl":{},
      "el":{},
      "status":{}
    };

    var y0 = 50;
    for (var i = 0; i < Object.size(coord_idx); i++) {
      for (var j = 0; j < Object.size(coord_idx[0]); j++) {
        var key = i.toString() + "_" + j.toString();
        state["vl"][key] = {};
        state["vl"][key]["state"] = VERTEX_RECT;
        if (i == 0 && j == 0) {
          state["vl"][key]["cx"] = left_start;
          state["vl"][key]["cy"] = 40 + i*30;
          state["vl"][key]["text"] = "i";        
          continue;  
        }
        if (j == 0) {
          state["vl"][key]["cx"] = left_start;
          state["vl"][key]["cy"] = 40 + i*30;
          state["vl"][key]["text"] = i-1;    
          continue;
        }        
        state["vl"][key]["cx"] = coord_idx[i][j];
        state["vl"][key]["cy"] = 40 + i*30;
        state["vl"][key]["text"] = coord_data[i][j];
      }
    }

    return state;
  }

  this.getGraphWidget = function() { return graphWidget; }
  
  this.getAmountVertex = function() { return amountVertex; }

  this.getAmountEdge = function() { return amountEdge; }

  function dist2P(x1, y1, x2, y2) {
    return Math.sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2));
  }

  // return the circle class id if is inside the circle
  // return -1 if free
  function isUsed(x,y) {
    var i, j;
    for (i = 0; i < amountVertex; i++) {
      if (dist2P(x, y, coord[i][0], coord[i][1]) <= 35)
       return i;
   }
   return -1;
  }

  function colorNode(cs, row_id, column_id) {
    cs["vl"][row_id.toString() + "_" + column_id.toString()]["state"] = VERTEX_HIGHLIGHTED_RECT;
  }

  function colorColumn(cs, column_id) {
    for (var i = 0; i < Object.size(coord_idx); i++)
      cs["vl"][i.toString() + "_" + column_id.toString()]["state"] = VERTEX_HIGHLIGHTED_RECT;
  }

  function colorRow(cs, row_id) {
    for (var i = 0; i < Object.size(coord_idx[0]); i++)
      cs["vl"][row_id.toString() + "_" + i.toString()]["state"] = VERTEX_HIGHLIGHTED_RECT;
  }

  function colorResultRow(cs, row_id) {
    for (var i = 0; i < Object.size(coord_idx[0]); i++)
      cs["vl"][row_id.toString() + "_" + i.toString()]["state"] = VERTEX_RESULT_RECT;
  }

  // Note: data.size must = no of rows
  function addColumn(data) {
    for (var i = 0; i < Object.size(data); i++) {
      var tmp = new Array();
      tmp.push(data[i]);
      appendRow(i, tmp);
    }
  }

  function appendRow(row_id, data) {
    var cur_y = 50 + 30*row_id;
    var sz = Object.size(coord_idx[row_id]);
    for (var i = 1; i <= Object.size(data); i++) {
      coord_idx[row_id][sz] = coord_idx[row_id][sz-1] + 150;
      coord_data[row_id][sz] = data[i-1];
      graphWidget.addRectVertex(coord_idx[row_id][sz], cur_y, data[i-1], row_id.toString() + "_" + sz.toString(), true, "rect_long");
      sz++;
    }
  }

  function addRow(data) {
    var sz = Object.size(coord_idx);
    coord_idx[sz] = new Array();
    coord_idx[sz][0] = left_start;
    coord_data[sz] = new Array();
    var cur_y = 40 + 30*sz;
    if (sz == 0)
      graphWidget.addRectVertex(left_start, cur_y, "i",  sz.toString() + "_0", true, "rect");
    else 
      graphWidget.addRectVertex(left_start, cur_y, (sz-1).toString(),  sz.toString() + "_0", true, "rect");
    for (var i = 1; i <= Object.size(data); i++) {
      coord_idx[sz][i] = coord_idx[sz][i-1] + 150; // unable to customize the column width well yet...
      coord_data[sz][i] = data[i-1];
      if (i == 1) coord_idx[sz][i] = coord_idx[sz][i-1] + 50;
      graphWidget.addRectVertex(coord_idx[sz][i], cur_y, data[i-1], sz.toString() + "_" + i.toString(), true, "rect_long");
    }
  }

  this.clrscr = function() {
    clearScreen();
  }
  
  function clearScreen() {
    var i, j;
    
    for (i = 0; i <= 500; i++) {
      try {
        graphWidget.removeEdge(i);
      } catch(err) {}
    }
    
    for (i = 0; i <= 500; i++) {
      try {
        graphWidget.removeVertex(i);
      } catch(err) {}
    }

    for (i = 0; i <= 30; i++)
      for (j = 0; j <= 5; j++)
        mainSvg.selectAll(".v" + i.toString() + "_" + j.toString()).remove();

    try {
      graphWidget.removeVertex(0);
    } catch (err) {}

    mainSvg.selectAll(".edgelabel").remove();
    mainSvg.selectAll("text").remove();
    amountVertex = 0;
    resetEverything();
  }  

  function stringCmp(a, b) {
    for (var i = 0; i < Math.min(a.length, b.length); i++) {
      if (a[i] < b[i]) return -1;
      else if (a[i] > b[i]) return 1;
    }
    if (a.length == b.length) return 0;
    else if (a.length > b.length) return 1;
    return -1;
  }

  
  function countingSort(T, k) {
    var SAText = T;
    var n = SAText.length;
    var i, sum, maxi = Math.max(300, n); // up to 255 ASCII chars or length of n
    c = new Array();
    for (var i = 0; i < 300; i++) c.push(0);
    for (i = 0; i < n; i++) // count the frequency of each rank
      c[i+k < n ? RA[i+k] : 0]++;
    sum = 0;
    for (i = 0; i < maxi; i++) {                     
      var t = c[i]; c[i] = sum; sum += t;
    }
    for (i = 0; i < n; i++) // shuffle the suffix array if necessary
      tempSA[c[SA[i]+k < n ? RA[SA[i]+k] : 0]++] = SA[i];
    for (i = 0; i < n; i++) // update the suffix array SA
      SA[i] = tempSA[i];
  }

  this.constructSA = function(T) { // this version can go up to 100000 characters
    clearScreen();
    populatePseudocode(0);
    var i, k, r;
    var cs = createState();
    var stateList = new Array();
    var n = T.length;

    var data = ["SA[i]", "Suffix", "RA[SA[i]]", "RA[SA[i]+k]", "tempRA[i]"];
    addRow(data);
    for (i = 0; i < n; i++) { 
      RA.push(T.charCodeAt(i));
      SA.push(i);
      var tmp = new Array();
      tmp.push(i);
      tmp.push(T.substring(i));
      tmp.push(T.charCodeAt(i));
      tmp.push(i+1 < n ? T.charCodeAt(i+1) : 0);
      tmp.push(0);
      addRow(tmp);
      tempRA.push(0);
    }
    cs = createState();
    cs["status"] = '使用[0..n-1]初始化SA []<br>用T（k = 1）中的字符的ASCII值初始化RA []<br>';
    cs["lineNo"] = 1;
    stateList.push(cs);

    if (T.charAt(n-1) != '$') {
      cs = createState();
      cs["status"] = '警告... T不以特殊符号&#39;$&#39;结尾<br>这种算法的结果不能保证<br>';
      cs["lineNo"] = 1;
      stateList.push(cs);
    }

    for (k = 1; k < n; k <<= 1) { // repeat sorting process log n times
      var SA_old = deepCopy(SA);
      countingSort(T, k); // actually radix sort: sort based on the second item
      countingSort(T, 0); // then (stable) sort based on the first item
      for (i = 0; i < n; i++) {
        coord_data[i+1][1] = SA[i];
        coord_data[i+1][2] = T.substring(SA[i]);
        if (k == 1) {
          coord_data[i+1][3] = T.charCodeAt(SA[i]);
          if (SA[i] < n-1) coord_data[i+1][4] = T.charCodeAt([SA[i]+1]);
          else             coord_data[i+1][4] = 0;
        }
        else {
          coord_data[i+1][3] = RA[SA[i]];
          coord_data[i+1][4] = RA[SA[i]+k];
          if (SA[i]+k >=n) coord_data[i+1][4] = 0;
          coord_data[i+1][5] = RA[SA[i]];
        }
      }

      cs = createState();
      cs["lineNo"] = 2;
      cs["status"] = "k = " + k + ", ";
      if (k == 1) {
        cs["status"] += '基于第一和第二字符的排名对进行排序<br>更改的行将突出显示<br>';
      } else if (k == 2) {
        cs["status"] += '基于第一和第二对的排名对进行排序<br>更改的行将突出显示<br>';
      } else if (k == 4) {
        cs["status"] += '基于第一和第二四元组的排名对进行排序<br>更改的行将突出显示<br>';
      } else {
        cs["status"] += '基于排名对排序（你知道dirll）<br>更改的行将突出显示<br>';
      }

      for (i = 0; i < Object.size(SA_old); i++)
        if (SA_old[i] != SA[i])
          colorRow(cs, i+1);
      stateList.push(cs);

      cs = createState();
      colorRow(cs, 1);
      cs["status"] = 'k = ' + k + '<br>现在执行重排序处理（tempRA [0]从0开始）<br>';
      cs["lineNo"] = 3;
      stateList.push(cs);

      tempRA[SA[0]] = r = 0; // re-ranking; start from rank r = 0
      for (i = 1; i < n; i++) { // compare adjacent suffices
        cs = createState();
        colorRow(cs, i+1);
        if (RA[SA[i]] == RA[SA[i-1]] && RA[SA[i]+k] == RA[SA[i-1]+k]) { // same rank
          coord_data[i+1][5] = r;
          tempRA[SA[i]] = r
          cs["status"] = "k = " + k + ', 与前一个后缀相同的排名对<br>保持排序为r = {r}<br>'.replace("{r}", r);
          cs["lineNo"] = 4;
        }
        else {
          coord_data[i+1][5] = ++r;
          tempRA[SA[i]] = r;
          cs["lineNo"] = [4, 5];
          cs["status"] = "k = " + k + ', 不同的排名对作为前缀<br>将排序增加到r = {r}<br>'.replace("{r}", r);
        }
        stateList.push(cs);
      }

      for (i = 0; i < n; i++) { // update the rank array RA
        RA[i] = tempRA[i];
        coord_data[i+1][3] = coord_data[i+1][5];
      }
      for (i = 0; i < n; i++) {
        coord_data[i+1][3] = RA[SA[i]];
        coord_data[i+1][4] = SA[i]+k*2 < n ? RA[SA[i]+k*2] : 0;
      }

      cs = createState();
      cs["status"] = '从tempRA []更新RA []<br>';
      cs["lineNo"] = 6; 
      colorColumn(cs, 3);
      colorColumn(cs, 4);
      stateList.push(cs);

      if (RA[SA[n-1]] == n-1) {
        cs = createState();
        cs["status"] = 'RA [SA [n-1] == n-1<br>所以我们完成了<br>';
        cs["lineNo"] = 7;
        stateList.push(cs);
        break;
      }
    } 

    graphWidget.startAnimation(stateList);
    return true;
  }

  function buildSA(T) {
    suffix_table = new Array();
    
    SA = new Array();
    for (var i = 0; i < T.length; i++) {
      suffix_table.push(T.substring(i));
      SA.push(i);
    }

    for (var i = 0; i < T.length-1; i++) 
      for (var j = i+1; j < T.length; j++) {
        if (suffix_table[i] > suffix_table[j]) {
          var tmp = suffix_table[i];
          suffix_table[i] = suffix_table[j];
          suffix_table[j] = tmp;
          tmp = SA[i];
          SA[i] = SA[j];
          SA[j] = tmp;
        }
      }
  }

  this.constructSA_bad = function(T) { // input size is small anyway
    clearScreen();
    var data = ["SA[i]", "LCP[i]", "Suffix T[SA[i]]"];
    addRow(data);
    buildSA(T);

    // LCP slow
    LCP = new Array();
    LCP.push(0);
    for (var i = 1; i < Object.size(SA); i++) {
      var L = 0;
      while (T[SA[i]+L] == T[SA[i-1]+L]) L++;
      LCP.push(L);
    }

    for (var i = 0; i < Object.size(SA); i++) {
      var tmp = new Array();
      tmp.push(SA[i]); tmp.push(LCP[i]); tmp.push(suffix_table[i]);
      addRow(tmp);
    }
  }

  function strncmp(str1, str2, n) {
    str1 = str1.substring(0, n);
    str2 = str2.substring(0, n);
    return ((str1 == str2) ? 0 :((str1 > str2) ? 1 : -1));
  }

  this.goSearch = function() {
    var P = document.getElementById("search_inp").value;
    var T = document.getElementById("T").value;
    populatePseudocode(1);
    this.constructSA_bad(T);
    var stateList = new Array();

    // find lower bound
    var cs = createState();
    cs["status"] = '查找下限<br>T中的第一次出现P =&#39;{P}&#39;<br>'.replace("{P}", P);
    cs["lineNo"] = 1;
    stateList.push(cs);
    var lo = 0, hi = T.length-1, mid = lo;
    while (lo < hi) {
      mid =  Math.floor((lo+hi) / 2);
      cs = createState();
      cs["status"] = '<span style="white-space: normal;">Low = {lo} and High = {hi}&nbsp;</span><div><span style="white-space: normal;">因此 Mid = ({lo}+{hi}) /2 = {mid}</span></div>'
                      .replace("{lo}", lo)
                      .replace("{hi}", hi)
                      .replace("{lo}", lo)
                      .replace("{hi}", hi)
                      .replace("{mid}", mid);
      cs["lineNo"] = 
      colorRow(cs, lo+1); colorRow(cs, hi+1); colorRow(cs, mid+1);
      stateList.push(cs);
      cs = createState();
      colorRow(cs, lo+1); colorRow(cs, hi+1); colorRow(cs, mid+1);
      var res = strncmp(T.substring(SA[mid]), P, P.length);
      if (res >= 0) {
        hi = mid;
        cs["status"] = 'P =&#39;{P}&#39;小于或等于此中间后缀“{substring}”<br>调整 High= Mid = {hi}<br>'
                        .replace("{P}", P)
                        .replace("{substring}", T.substring(SA[mid]))
                        .replace("{hi}", hi);
      }
      else {
        lo = mid+1;
        cs["status"] = 'P =&#39;{P}&#39;大于这个中间后缀“{substring}”<br>调整<span style="white-space: normal;">Low = Mid+1 = {lo}</span><br>'
                        .replace("{P}", P)
                        .replace("{substring}", T.substring(SA[mid]))
                        .replace("{lo}", lo);
      }
      cs["lineNo"] = 1;
      stateList.push(cs);
    }

    if (strncmp(T.substring(SA[lo]), P, P.length) != 0) {
      cs = createState();
      cs["status"] = 'P =&#39;{P}&#39;在T中找不到，退出...<br>'.replace("{P}", P);
      cs["lineNo"] = 3;
      stateList.push(cs);
      graphWidget.startAnimation(stateList);
      return true;
    }

    var lower_bound = lo;
    cs = createState();
    cs["status"] = '下划线（<span style="white-space: normal;">suffix&nbsp;</span>{SA_lo} =&#39;{substring}&#39;）被突出显示<br>'
                    .replace("{SA_lo}", SA[lo])
                    .replace("{substring}", T.substring(SA[lo]));
    cs["lineNo"] = 1;
    colorRow(cs, lower_bound+1);

    stateList.push(cs);
    cs = createState();
    cs["status"] = '查找上限<br>T中的最后一次出现P =&#39;{P}&#39;<br>'.replace("{P}", P);
    cs["lineNo"] = 2;
    stateList.push(cs);

    // find upper bound
    var lo = 0, hi = T.length-1, mid = lo;
    while (lo < hi) {
      mid =  Math.floor((lo+hi) / 2);
      cs = createState();
      cs["status"] = 'Low = {lo} and High = {hi}<br>So Mid = ({lo}+{hi}) / 2 = {mid}<br>'
                      .replace("{lo}", lo)
                      .replace("{hi}", hi)
                      .replace("{lo}", lo)
                      .replace("{hi}", hi)
                      .replace("{mid}", mid);
      cs["lineNo"] = 2;
      colorRow(cs, lo+1); colorRow(cs, hi+1); colorRow(cs, mid+1);
      stateList.push(cs);
      cs = createState();
      colorRow(cs, lo+1); colorRow(cs, hi+1); colorRow(cs, mid+1);
      var res = strncmp(T.substring(SA[mid]), P, P.length);
      if (res > 0) {
        hi = mid;
        cs["status"] = 'P =&#39;{P}&#39;小于这个中间后缀“{substring}”<br>调整高= Mid = {hi}<br>'
                        .replace("{P}", P)
                        .replace("{substring}", T.substring(SA[mid]))
                        .replace("{hi}", hi);
      }
      else {
        lo = mid+1;
        cs["status"] = 'P =&#39;{P}&#39;大于或等于此中间后缀“{substring}”<br>调整低=中+ 1 = {lo}<br>'
                        .replace("{P}", P)
                        .replace("{substring}", T.substring(SA[mid]))
                        .replace("{lo}", lo);
      }
      cs["lineNo"] = 2;
      stateList.push(cs);
    }
    if (strncmp(T.substring(SA[hi]), P, P.length) != 0) hi--;
    var h_bound = hi;

    var cs = createState();
    colorRow(cs, h_bound+1);
    cs["status"] = '上界（后缀{SA_hi} =&#39;{substring}&#39;）被突出显示<br>'
                    .replace("{SA_hi}", SA[hi])
                    .replace("{substring}", T.substring(SA[hi]));
    cs["lineNo"] = 2;
    stateList.push(cs);

    var cs = createState();
    cs["status"] = '搜索完成<br>结果从下限到上限突出显示<br>';
    cs["lineNo"] = 3;
    for (var i = lower_bound+1; i < h_bound+2; i++) colorRow(cs, i);
    stateList.push(cs);

    graphWidget.startAnimation(stateList);
    return true;
  }

  this.goLCP = function() { // is it Kasai's algorithm? for computing LCP (check the proper name)
    var T = document.getElementById("T").value;
    clearScreen();
    populatePseudocode(2);
    var i, k, r;
    var cs = createState();
    var stateList = new Array();
    var n = T.length;

    var data = ["SA[i]", "Phi[i]", "PLCP[i]", "Suffix", "LCP[i]"];
    addRow(data);
    buildSA(T);

    var Phi = new Array();
    for (i = 0; i < n; i++) Phi.push(0);
    Phi[SA[0]] = -1;
    for (i = 1; i < n; i++) Phi[SA[i]] = SA[i-1];

    for (i = 0; i < n; i++) { 
      var tmp = new Array();
      tmp.push(SA[i]);
      tmp.push(0);
      tmp.push(0);
      tmp.push(T.substring(i));
      tmp.push(0);
      addRow(tmp);
    }

    coord_data[SA[0]+1][2] = Phi[SA[0]]; // -1
    cs = createState();
    cs["status"] = '初始化Phi，PLCP和LCP列<br>';
    colorColumn(cs, 2);
    colorColumn(cs, 3);
    colorColumn(cs, 5);
    cs["lineNo"] = 1; 
    stateList.push(cs);

    for (i = 1; i < n; i++) {
      coord_data[SA[i]+1][2] = Phi[SA[i]];
      cs = createState();      
      cs["status"] = '<span style="white-space: normal;">更新 Phi[{SA_i}] = {SA_i-1}</span><br>'
                      .replace("{SA_i}", SA[i])
                      .replace("{SA_i-1}", SA[i-1]);
      cs["lineNo"] = 1;
      colorNode(cs, i, 1);
      colorNode(cs, i+1, 1);
      colorNode(cs, SA[i]+1, 2);
      stateList.push(cs);
    }

    var L = 0, PLCP = new Array();
    for (i = 0; i < n; i++) {
      if (Phi[i] == -1) {
        PLCP[i] = 0;
        continue;
      }
      while (T[i+L] == T[Phi[i]+L]) L++;
      PLCP[i] = L;
      L = L > 1 ? L-1 : 0;
    }
    for (i = 0; i < n; i++) {
      coord_data[i+1][3] = PLCP[i];
      cs = createState();
      colorRow(cs, i+1);
      cs["status"] = '<span style="white-space: normal;">更新 PLCP[{i}]. L={PLCP_i}</span>'
                      .replace("{i}", i)
                      .replace("{PLCP_i}", PLCP[i].toString());
      cs["lineNo"] = 5;
      stateList.push(cs);
    }

    for (i = 0; i < n; i++) {
      coord_data[i+1][5] = PLCP[SA[i]];
      cs = createState();
      colorNode(cs, i+1, 5);
      colorNode(cs, SA[i]+1, 3);
      cs["status"] = '更新LCP [{i}] = {PLCP_SA_i}<br>'
                      .replace("{i}", i)
                      .replace("{PLCP_SA_i}", PLCP[SA[i]]);
      cs["lineNo"] = 6;
      stateList.push(cs);
    }

    cs = createState();
    cs["status"] = '结束'
    stateList.push(cs);   

    graphWidget.startAnimation(stateList);
    return true; 
  }

  this.goLRS = function() {
    populatePseudocode(3);
    var T = document.getElementById("T").value;
    this.constructSA_bad(T);

    var cs = createState();
    var stateList = new Array();
    cs["status"] = 'Simple O(<b>n</b>) check over the LCP column (skip row 0)<br>ans = 0, current best suffix(es) will be colored green';
    cs["lineNo"] = 1;
    stateList.push(cs);

    var max = 0, save = new Array();
    for (var i = 1; i < Object.size(LCP); i++) {
      var cs = createState();
      colorRow(cs, i+1);
      //cs["status"] = "Checking LCP[" + i + "] = " + LCP[i];
      cs["lineNo"] = 2;
      for (var j = 0; j < Object.size(save); j++)
        colorResultRow(cs, save[j]+1);
      stateList.push(cs);

      cs = createState();
      if (LCP[i] == 0) {
        //cs["status"] = "LCP[" + i + "] = " + LCP[i] + " (zero will not beat the max = " + max + ")<br>Just continue";
        cs["status"] = 'LCP[{i}] = {LCP_i} (zero does not beat the max = {max})<br>Just continue'
                        .replace('{i}', i)
                        .replace('{LCP_i}', LCP[i])
                        .replace('{max}', max);
        cs["lineNo"] = 3;

      } else if (LCP[i] > max) {
        //cs["status"] = "LCP[" + i + "] = " + LCP[i] + " is bigger than max = " + max + "<br>Update max = " + LCP[i] + " and set result array to only has this suffix";
        cs["status"] = 'LCP[{i}] = {LCP_i} is bigger than max = {max}<br>Update max = {LCP_i} and set result array to only has this suffix'
                        .replace('{i}', i)
                        .replace('{LCP_i}', LCP[i])
                        .replace('{max}', max)
                        .replace('{LCP_i}', LCP[i]);
        max = LCP[i];
        save = new Array();
        save.push(i);
        cs["lineNo"] = [3, 4];

      } else if (LCP[i] == max) {
        //cs["status"] = "LCP[" + i + "] = " + LCP[i] + " is equal to max = " + max + "<br>Keep max but add this suffix to result array";
        cs["status"] = 'LCP[{i}] = {LCP_i} is equal to max = {max}<br>Keep max but add this suffix to result array'
                        .replace('{i}', i)
                        .replace('{LCP_i}', LCP[i])
                        .replace('{max}', max);
        save.push(i);
        cs["lineNo"] = [3, 4];

      } else {
        cs["status"] = 'LCP[{i}] = {LCP[i]} is smaller than max = {max}<br>Just continue'
                        .replace('{i}', i)
                        .replace('{LCP_i}', LCP[i])
                        .replace('{max}', max);
        cs["lineNo"] = 3;
        colorRow(cs, i+1);
      }
      for (var j = 0; j < Object.size(save); j++)
        colorResultRow(cs, save[j]+1);
      stateList.push(cs);
    }

    cs = createState();
    cs["lineNo"] = 5;
    if (max > 0) {
      var ans = T.substring(SA[save[0]], SA[save[0]]+LCP[save[0]]);
      //cs["status"] = "The Longest Repeated Substring of '{T}'<br>is '{ans}' (length {LCP[save[0]]}), the prefix of the green-colored rows";
      cs["status"] = 'The Longest Repeated Substring of "{T}"<br>is "{ans}" (length {length}), the prefix of the green-colored rows'
                      .replace('{T}', T)
                      .replace('{ans}', ans)
                      .replace('{length}', LCP[save[0]]);
      for (var j = 0; j < Object.size(save); j++)
        colorResultRow(cs, save[j]+1);
    }
    else
      cs["status"] = 'The Longest Repeated Substring of "{T}"<br>is "<i>null string</i>" (length 0) as there is no repeated character at all'.replace('{T}', T);
    stateList.push(cs);

    graphWidget.startAnimation(stateList);
    return true;
  }

  this.goLCS = function() {
    var owner = new Array();
    populatePseudocode(4);
    var s1 = document.getElementById("s1").value, s2 = document.getElementById("s2").value;
    var T = s1+s2;
    this.constructSA_bad(T);
    owner.push("Owner");
    for (var i = 0; i < Object.size(SA); i++) {
      var tmp = T.substring(SA[i]);
      if (tmp.indexOf("#") == -1)
        owner.push(2);
      else
        owner.push(1);
    }
    addColumn(owner);
    owner = owner.splice(1);

    var cs = createState();
    var stateList = new Array();
    var max = 0;
    var save = new Array();
    cs["status"] = 'Simple O(<b>n</b>) check over the LCP+owner column (skip row 0)<br>ans = 0, current best suffix(es) will be colored green';
    cs["lineNo"] = 1;
    stateList.push(cs);

    cs = createState();
    cs["status"] = 'Start at index 1';
    cs["lineNo"] = 2; 
    colorRow(cs, 2);
    stateList.push(cs);

    for (var i = 1; i < Object.size(SA); i++) {
      cs = createState();
      colorRow(cs, i+1);
      if (owner[i] == owner[i-1]) {
        cs["status"] = 'Same owner as previous index<br>Continue';
        cs["lineNo"] = 3;
      }
      else {
        cs["status"] = 'Different owner as previous index ';
        cs["lineNo"] = 4;
        if (LCP[i] > max) {
          max = LCP[i];
          //cs["status"] += "LCP[i]=" + LCP[i] + " max=" + max + "<br>Update max";
          cs["status"] += 'LCP[i]={LCP_i} max={max}<br>Update max'
                            .replace('{LCP_i}', LCP[i])
                            .replace('{max}', max);
          save = new Array();
          save.push(i);
        } else if (LCP[i] == max) {
          save.push(i);
          cs["status"] += 'LCP[i]={LCP_i} max={max}<br>Update result'
                            .replace('{LCP_i}', LCP[i])
                            .replace('{max}', max);
        } else
          cs["status"] += 'LCP[i]={LCP_i} max={max}<br>Continue'
                            .replace('{LCP_i}', LCP[i])
                            .replace('{max}', max);
      }
      for (var j = 0; j < Object.size(save); j++)
        colorResultRow(cs, save[j]+1);
      stateList.push(cs);
    }

    cs = createState();
    cs["status"] = 'Finish';
    cs["lineNo"] = 5;
    for (var j = 0; j < Object.size(save); j++)
      colorResultRow(cs, save[j]+1);
    stateList.push(cs);

    graphWidget.startAnimation(stateList);
    return true;
  }

  // Javascript addon: get size of an object
  Object.size = function(obj) {
    var size = 0, key;
    for (key in obj)
      if (obj.hasOwnProperty(key))
        size++;
    return size;
  };

  function populatePseudocode(act) {
    switch (act) {
      case 0: // constructSA
        $("#code1").html('for (k = 1; k < n; k <<= 1) // O(log <b>n</b>)');
        $("#code2").html('&nbsp;&nbsp;sort based on ranking pair // O(<b>n</b>)');
        $("#code3").html('&nbsp;&nbsp;for (i = 1; i < n; i++)');
        $("#code4").html('&nbsp;&nbsp;&nbsp;&nbsp;if ranking pair is different');
        $("#code5").html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;increase rank');
        $("#code6").html('&nbsp;&nbsp;updating RA[] from tempRA[]');
        $("#code7").html('finish');
        break;
      case 1: // Search
        $("#code1").html('find lower bound // O(<b>m</b> log <b>n</b>)');
        $("#code2").html('find upper bound // O(<b>m</b> log <b>n</b>)');
        $("#code3").html('report results');
        $("#code4").html('');
        $("#code5").html('');
        $("#code6").html('');
        $("#code7").html('');
        break;
      case 2: // LCP
        $("#code1").html('for (i = 1; i < n; i++) Phi[SA[i]] = SA[i-1]');
        $("#code2").html('for (i = L = 0; i < n; i++)');
        $("#code3").html('&nbsp;&nbsp;if (Phi[i] == -1) PLCP[i] = 0, continue');
        $("#code4").html('&nbsp;&nbsp;increase L properly');
        $("#code5").html('&nbsp;&nbsp;L = max(L - 1, 0)');
        $("#code6").html('for (i = 0; i < n; i++) LCP[i] = PLCP[SA[i]]');
        $("#code7").html('// Overall O(<b>n</b>) via PLCP theorem');
        break;
      case 3: // LRS
        $("#code1").html('max = 0, result = null');
        $("#code2").html('for i = 1 to n-1');
        $("#code3").html('&nbsp;&nbsp;if (LCP[i] >= max)');
        $("#code4").html('&nbsp;&nbsp;&nbsp;&nbsp;update max and result');
        $("#code5").html('return result');
        $("#code6").html('// LRS length is unique');
        $("#code7").html('// But LRS substring(s) may not be unique');
        break;
      case 4: // LCS
        $("#code1").html('max = 0, result = null');
        $("#code2").html('for i = 1 to n-1');
        $("#code3").html('&nbsp;&nbsp;if (owner[i] == owner[i-1] continue');
        $("#code4").html('&nbsp;&nbsp;if (LCP[i] >= max) update max, result');
        $("#code5").html('return result');
        $("#code6").html('// LCS length is unique');
        $("#code7").html('// But LCS substring may not be unique');
        break;
    } 
  }
}

// Suffix Array action
var actionsWidth = 180;
var statusCodetraceWidth = 370;

var isConstructOpen = false;
var isSearchOpen = false;
var isLCPOpen = false;
var isLRSOpen = false;
var isLCSOpen = false;

function openConstruct() {
  if (!isConstructOpen) {
    $('.construct').fadeIn('fast');
    isConstructOpen = true;
  }
}

function closeConstruct() {
  if (isConstructOpen) {
    $('.construct').fadeOut('fast');
    $('#construct-err').html(""); 
    isConstructOpen = false;
  }
}

function openSearch() {
  if (!isSearchOpen) {
    $('.search').fadeIn('fast');
    isSearchOpen = true;
  }
}

function closeSearch() {
  if (isSearchOpen) {
    $('.search').fadeOut('fast');
    $('#search-err').html("");
    isSearchOpen = false;
  }
}

function openLCP() {
  if (!isLCPOpen) {
    $('.lcp').fadeIn('fast');
    isLCPOpen = true;
  }
}

function closeLCP() {
  if (isLCPOpen) {
    $('.lcp').fadeOut('fast');
    $('#lcp-err').html(""); 
    isLCPOpen = false;
  }
}

function openLRS() {
  if (!isLRSOpen) {
    $('.lrs').fadeIn('fast');
    isLRSOpen = true;
  }
}

function closeLRS() {
  if (isLRSOpen) {
    $('.lrs').fadeOut('fast');
    $('#lrs-err').html(""); 
    isLRSOpen = false;
  }
}

function openLCS() {
  if (!isLCSOpen) {
    $('.lcs').fadeIn('fast');
    isLCSOpen = true;
  }
}

function closeLCS() {
  if (isLCSOpen) {
    $('.lcs').fadeOut('fast');
    $('#lcs-err').html(""); 
    isLCSOpen = false;
  }
}

function hideEntireActionsPanel() {
  closeConstruct();
  closeSearch();
  closeLCP();
  closeLRS();
  closeLCS();
  hideActionsPanel();
}



// local
//start by showing actions panel
$('#play').hide();
var saWidget = new SuffixArrayWidget();
var gw = saWidget.getGraphWidget();
saWidget.constructSA_bad($("#T").val());

$(function() {
  $('#construct').click(function() {
    openConstruct();
    closeSearch();
    closeLCP();
    closeLRS();
    closeLCS();
  }); 

  $('#search').click(function() {
    closeConstruct();
    openSearch();
    closeLCP();
    closeLRS();
    closeLCS();
  });

  $("#LCP").click(function() {
    closeConstruct();
    closeSearch();
    closeLCP();
    closeLRS();
    closeLCS();
  });

  $("#LRS").click(function() {
    closeConstruct();
    closeSearch();
    closeLCP();
    openLRS();
    closeLCS();
  });
  
  $("#LCS").click(function() {
    closeConstruct();
    closeSearch();
    closeLCP();
    closeLRS();
    openLCS();
  });
});

function constructSuffixArray() {
  try {
    if (isPlaying) { stop(); }
  } 
  catch (err) {}
  setTimeout(function() {
    if ((mode == "exploration") && saWidget.constructSA($("#T").val())) {
      $('#current-action').show();
      var T = $("#T").val();
      $('#current-action p').html('Construct Suffix Array of<br>T = "{T}"'.replace('{T}', T));
      $('#progress-bar').slider("option", "max", gw.getTotalIteration()-1);
      triggerRightPanels();
      isPlaying = true;
    }
  }, 500); 
}

function doSearch() {
  try {
    if (isPlaying) { stop(); }
  }
  catch(err) {}
  setTimeout(function() {
    if ((mode == "exploration") && saWidget.goSearch()) {
      $('#current-action').show();
      var input = $('#search_inp').val();
      var T = $("#T").val();
      $('#current-action p').html('Search P = "{input}"<br>in T = "{T}"'.replace('{input}', input).replace('{T}', T));
      $('#progress-bar').slider("option", "max", gw.getTotalIteration()-1);
      triggerRightPanels();
      isPlaying = true;
    }
  }, 500);   
}

function doLCP() {
  try {
    if (isPlaying) { stop(); }
  } catch(err) {}
  setTimeout(function() {
    if ((mode == "exploration") && saWidget.goLCP()) {
      $('#current-action').show();
      $('#current-action p').html('Longest Common Prefix');
      $('#progress-bar').slider("option", "max", gw.getTotalIteration()-1);
      triggerRightPanels();
      isPlaying = true;
    }
  }, 500);      
}

function doLRS() {
  try {
    if (isPlaying) { stop(); }
  } catch(err) {}
  setTimeout( function() {
    if ((mode == "exploration") && saWidget.goLRS()) {
      $('#current-action').show();
      var T = $("#T").val()
      $('#current-action p').html('Longest Repeated Substring of T = "{T}"'.replace('{T}', T));
      $('#progress-bar').slider("option", "max", gw.getTotalIteration()-1);
      triggerRightPanels();
      isPlaying = true;
    }
  }, 500);      
}

function doLCS() {
  try {
    if (isPlaying) { stop(); }
  } catch(err) {}
  setTimeout(function() {
    if ((mode == "exploration") && saWidget.goLCS()) {
      $('#current-action').show();
      var s1 = $("#s1").val();
      var s2 = $("#s2").val();
      $('#current-action p').html('Longest Common Substring of T1 = "{s1}" and T2 = "{s2}"'.replace('{s1}', s1).replace('{s2}', s2));
      $('#progress-bar').slider("option", "max", gw.getTotalIteration()-1);
      triggerRightPanels();
      isPlaying = true;
    }
  }, 500);      
}
</script>
</body>
</html>
